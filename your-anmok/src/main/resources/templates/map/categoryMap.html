<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <title>ë‹¹ì‹ ì˜ ì•ˆëª© ë©”ì¸í˜ì´ì§€</title>

    <style>
        .map_wrap, .map_wrap * {
            margin:0;
            padding:0;
            font-family: 'Cafe24SsurroundAir';
            font-size:12px;
        }
    </style>

    <!--ì œì´ì¿¼ë¦¬-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <!--bxSlider JS-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bxslider/4.2.15/jquery.bxslider.min.js"></script>
    <!--bxSlider CSS-->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bxslider/4.2.15/jquery.bxslider.min.css" rel="stylesheet" />
    <!--í…Œì¼ìœˆë“œ-->
    <script src="https://cdn.tailwindcss.com"></script>
    <!--ë¶€íŠ¸ìŠ¤íŠ¸ë© CSS-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <!--ë¶€íŠ¸ìŠ¤íŠ¸ë© JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <!--ë°ì´ì§€UI-->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@2.20.0/dist/full.css" rel="stylesheet" type="text/css" />
    <!--í°íŠ¸ì–´ì¸-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/all.min.css"/>
    <!--ì¹´ì¹´ì˜¤-->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=0faeb3dc4793a50259747d85fd7d9a89&libraries=services"></script>
    <!--CSSíŒŒì¼-->
    <link rel="stylesheet" type="text/css" href="/css/popup/popup.css">
    <link rel="stylesheet" type="text/css" href="/css/map/map.css">
</head>

<body>
<div class="map_wrap" style="position: relative;">
    <div id="map" class="w-screen h-screen" >

    </div>


    <button id="my_location_button" onclick="getCurrentPosBtn()">
        <i class="fas fa-crosshairs fa-2x"></i>
    </button>
    <form th:action="@{/searchMap}" id="searchMapFormByCategoryId">
        <input type="text" name="categoryId" th:value="${categoryId}" id="searchMapButtonByCategoryId" size="15" style="display: none;" />
        <button id="addPlaceinCategory" type="submit">í˜„ì¬ ì¹´í…Œê³ ë¦¬ì— ì¥ì†Œ ì¶”ê°€í•˜ê¸°</button>
    </form>
    <button id="makeMyCategory" onclick="location.href='/category/add'">ë‚˜ë§Œì˜ ì¹´í…Œê³ ë¦¬ ë§Œë“¤ê¸°</button>

    <div id="menu">
        <div class="close"></div>

        <div id="categoryCard" class="d-flex flex-row btn-group my-3 " role="group">
            <button id="hamburger_button" type="button">
                <i class="fas fa-bars fa-2x"></i>
            </button>
            <div id="categoryNameTag" th:text="${categoryName}"></div>
        </div>

        <div class="left_sub_menu">
            <div class="sub_menu">
                <div class="d-flex flex-row justify-between">
                    <a class="h3" href="/">ë‹¹ì‹ ì˜ ì•ˆëª© ğŸ‘€</a>
                        <form action="/auth/loginProc" method="post">
                            <a sec:authorize="isAnonymous()" href="https://kauth.kakao.com/oauth/authorize?client_id=84bb53ddc4e742b0c6aa6c06a6372dbc&redirect_uri=http://localhost:8080/auth/kakao/callback&response_type=code"><img width="70px" height="50px" src="/image/KakaoLoginBtn.jpg"></a>
                            <div class="btn btn-warning" sec:authorize="isAuthenticated()"><a class="text-white text-decoration-none" href="/logout">ë¡œê·¸ì•„ì›ƒ</a></div>
                        </form>
                </div>

                <ul class="big_menu">
                    <li><a href="/category/home">ğŸ ì¹´í…Œê³ ë¦¬</a></li>
                </ul>
                <ul class="big_menu">
                    <li><a href="/gathering/list">âš¡ï¸ ë²ˆê°œëª¨ì„</a></li>
                </ul>
                <ul class="big_menu">
                    <li><a sec:authorize="isAuthenticated()" href="/mypage">ğŸ› ë§ˆì´í˜ì´ì§€</a></li>
                </ul>
            </div>
        </div>

    </div>
    <div id="category_item_list_wrap">
        <ul id="placeList">
            <div class="recommendedTitle">ì¶”ì²œì¥ì†Œ</div>

        </ul>
    </div>
</div>

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=0faeb3dc4793a50259747d85fd7d9a89&libraries=services&autoload=false"></script>


<script th:inline="javascript">
    // ì»¨íŠ¸ë¡¤ëŸ¬ì— ìˆëŠ” ê°’ì„ th:inline="javascript"ë¥¼ í†µí•´ ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ê°€ì ¸ì˜¤ê¸° ë°‘ì— ìˆëŠ” ì£¼ì„ì€ ê¼­ ë‹¬ì•„ì¤˜ì•¼ í•œë‹¤.

    /*<![CDATA[*/

    let allPlaceList = [[${allPlaceList}]];
    console.log(allPlaceList);

    /*]]>*/

</script>

<script>
    let container = document.getElementById("map");
    let options = {
        // ì¼ë‹¨ í™ëŒ€ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì¡ëŠ” ë§µ ìƒì„±
        center: new kakao.maps.LatLng(37.511133583298516, 126.97978788338133),
        // // ì¼ë‹¨ ì ë‹¹í•œ ì§€ë„ì˜ ë†’ì´ ë ˆë²¨ 7 ì •ë„ë¡œ ìˆ˜ì •
        level: 7
    };

    let map = new kakao.maps.Map(container, options);

    $(function () {
        $(".left_sub_menu").hide();
        $("#hamburger_button").click(function () {
            $(".left_sub_menu").fadeToggle(300);
        });
        // // ì™¼ìª½ë©”ë‰´ ë“œë¡­ë‹¤ìš´
        // $(".sub_menu ul.small_menu").hide();
        // $(".sub_menu ul.big_menu").click(function () {
        //     $("ul", this).slideToggle(300);
        // });
        // ì™¸ë¶€ í´ë¦­ ì‹œ ì¢Œì¸¡ ì‚¬ì´ë“œ ë©”ë‰´ ìˆ¨ê¸°ê¸°
        $('#map').on('click', function () {
            $('.left_sub_menu').fadeOut();
            $('.hide_sidemenu').fadeIn();
        });
    });

    // ì£¼ì†Œ - ì¢Œí‘œ ë³€í™˜ ê°ì²´ë¥¼ ìƒì„±í•œë‹¤.
    let geocoder = new kakao.maps.services.Geocoder();

    function closePopup() {
        document.getElementById("detail_popup_layer").style.display = "none"
    }

    function slider() {
        var slide = $('.bxslider').bxSlider({
            mode: "horizontal",    // ê°€ë¡œ ìˆ˜í‰ìœ¼ë¡œ ìŠ¬ë¼ì´ë“œëœë‹¤.
            speed: 200,        // ì´ë™ ì†ë„ë¥¼ ì„¤ì •í•œë‹¤.
            pager: false,    // í˜„ì¬ ìœ„ì¹˜ í˜ì´ì§€ í‘œì‹œ ì—¬ë¶€ë¥¼ ì„¤ì •í•œë‹¤.
            moveSlides: 2,    // ìŠ¬ë¼ì´ë“œ ì´ë™ ì‹œ ê°œìˆ˜ë¥¼ ì„¤ì •í•œë‹¤.
            slideWidth: 280,    // ìŠ¬ë¼ì´ë“œ ë„ˆë¹„ë¥¼ ì„¤ì •í•œë‹¤.
            minSlides: 4,    // ìµœì†Œ ë…¸ì¶œ ê°œìˆ˜ë¥¼ ì„¤ì •í•œë‹¤.
            maxSlides: 4,    // ìµœëŒ€ ë…¸ì¶œ ê°œìˆ˜ë¥¼ ì„¤ì •í•œë‹¤.
            slideMargin: 28, // ìŠ¬ë¼ì´ë“œ ê°„ì˜ ê°„ê²©ì„ ì„¤ì •í•œë‹¤.
            auto: true,         // ìë™ìœ¼ë¡œ íë¥¼ì§€ ì—¬ë¶€ë¥¼ ì„¤ì •í•œë‹¤.
            autoHover: true, // ë§ˆìš°ìŠ¤ì˜¤ë²„ ì‹œ ì •ì§€í• ì§€ë¥¼ ì„¤ì •í•œë‹¤.
            controls: true    // ì´ì „ ë²„íŠ¼, ë‹¤ìŒ ë²„íŠ¼ ë…¸ì¶œ ì—¬ë¶€ë¥¼ ì„¤ì •í•œë‹¤.
        });

        slide.reloadSlider();
    };

    let placeList = document.getElementById('placeList');

    // ì£¼ì†Œë¡œ ì¢Œí‘œë¥¼ ê²€ìƒ‰í•œë‹¤. í…Œì´ë¸” ì£¼ì†Œ -> ì¢Œí‘œ -> ì§€ë„ì— ë§ˆì»¤ë¡œ í‘œì‹œ
    for (let i =0;i<allPlaceList.length;i++) {

        geocoder.addressSearch(allPlaceList[i].address, function (result, status) {
            let coords = new kakao.maps.LatLng(result[0].y, result[0].x);

            // ê²°ê³¼ê°’ìœ¼ë¡œ ë°›ì€ ìœ„ì¹˜ë¥¼ ë§ˆì»¤ë¡œ í‘œì‹œ
            let marker = new kakao.maps.Marker({
                map: map,
                position: coords
            });



            kakao.maps.event.addListener(marker, 'click', function (){
               // location.href="/place/"+allPlaceList[i].id+"#load";

                $("#detail_popup_layer").modal('show');

                $.ajax({
                    url : "/place/"+allPlaceList[i].id,
                    type : "GET",
                    async: false,
                    success : function(data){
                        console.log(data);
                        console.log(data.place.name);
                        $('p[id=place_info_placeName]').text(data.place.name);
                        $('p[id=place_info_placeAddress]').text(data.place.address);


                        let categorySize = data.categoryList.length;
                        let gatheringSize = data.placeGatheringDtos.length;
                        let imageSize = data.placeImages.length;
                        let starSize = data.place.star;
                        let emptyStarSize = 5-data.place.star;

                        console.log("ì¹´í…Œê³ ë¦¬ ì‚¬ì´ì¦ˆëŠ”"+categorySize);
                        console.log("ì¹´í…Œê³ ë¦¬ ì´ë¦„:"+data.categoryList[0].tagName);
                        function categoryDOM(categoryList){
                            let tr = '';

                            tr+=`<tr>`;
                            for (let i=0;i<categorySize;i++) {
                                tr += `    <button class="categoryNameBtn" onclick="location.href='/category?id=${categoryList[i].id}'">${categoryList[i].tagName}</button>`
                            }

                            tr+=`</tr>`;
                            console.log(tr);
                            document.getElementById("place_info_categoryList").innerHTML=tr;
                        }

                        function gatheringDOM(gatheringList){
                            let tr = '';

                            tr+=`<tr>`;
                            for (let i=0;i<gatheringSize;i++){
                                tr +=`    <button class="gathingTitleBtn" onclick="location.href='/gathering/${gatheringList[i].id}'">${gatheringList[i].title}</button>`
                            }
                            tr+=`</tr>`;
                            console.log(tr);
                            document.getElementById("place_info_gatheringList").innerHTML=tr;
                        }

                        function starDOM(star){
                            let tr = '';

                            tr+=`<tr>`;
                            for (let i=0;i<starSize;i++){
                                tr +=`    <img src="/images/star.png" class="star">`
                            }
                            tr+=`</tr>`;

                            tr+=`<tr>`;
                            for (let i=0;i<emptyStarSize;i++){
                                tr +=`    <img src="/images/empty_star.png" class="star">`
                            }
                            tr+=`</tr>`;
                            console.log(tr);
                            document.getElementById("star_box").innerHTML=tr;
                        }

                        function imageDOM(placeImages){
                            let ul = '';
                            if(imageSize!=0) {
                                ul += `<ul class="bxslider">`;
                                ul += `    <tr>`;
                                for (let i = 0; i < imageSize; i++) {
                                    ul += `        <li><img class="usr_img" src="/placeimg/${placeImages[i].filePath}"></li>`
                                }
                                ul += `    </tr>`;
                                ul += `</ul>`;
                            }
                            document.getElementById("place_info_imageList").innerHTML=ul;
                        }

                        categoryDOM(data.categoryList);
                        gatheringDOM(data.placeGatheringDtos);
                        imageDOM(data.placeImages);
                        starDOM(data.place.star);

                        slider();
                    }
                });

            });

            let content = '<div class="customoverlay">' +

                '   <span class="title">'+allPlaceList[i].name+'</span>' +

                '</div>';

            let customOverlay = new kakao.maps.CustomOverlay({
                map:map,
                position: coords,
                content:content,
                yAnchor:0.2
            });


            let listItem = document.createElement("div");
            listItem.setAttribute("class","listItem bg-white text-center py-2 rounded-[10px] h-[50px] my-[3px]");
            let item="";
            item+=`<div class="list_item_name">`+allPlaceList[i].name+`</div>`;
            item+=`<div class="list_item_address">`+allPlaceList[i].address+`</div>`;


            listItem.innerHTML=item;
            placeList.appendChild(listItem);


            (function(map, marker, customOverlay, listItem) {

                kakao.maps.event.addListener(marker,'mouseover',function (){
                    listItem.classList.remove('bg-white');
                    listItem.classList.add('bg-[#7FD1AE]');
                });

                kakao.maps.event.addListener(marker,'mouseout',function (){
                    listItem.classList.add('bg-white');
                    listItem.classList.remove('bg-[#7FD1AE]');
                });

                listItem.onmouseover = function (){
                }

                listItem.onmouseout = function (){
                }

            })(map, marker, customOverlay, listItem);


            // kakao.maps.event.addEventListener(marker, 'mouseout', function () {
            //     // ë§ˆì»¤ì— ë§ˆìš°ìŠ¤ì•„ì›ƒ ì´ë²¤íŠ¸ ë°œìƒí•˜ë©´ ì¸í¬ìœˆë„ìš° ì œê±°
            //     infowindow.close();
            //
            // });

        })


    }

        function locationLoadSuccess(pos) {
            let currentPos = new kakao.maps.LatLng(
                pos.coords.latitude,
                pos.coords.longitude
            );

            map.panTo(currentPos);
            map.setLevel(4);
        }

        function getCurrentPosBtn() {
            navigator.geolocation.getCurrentPosition(locationLoadSuccess, null);
            console.log("í˜„ì¬ìœ„ì¹˜ ë²„íŠ¼ í´ë¦­ë¨");
        }

</script>

<!--ì¥ì†Œ ìƒì„¸ íŒì—…ì°½ ë ˆì´ì•„ì›ƒ html-->
<div id="detail_popup_layer">
    <div id="popup_box1">
        <!--íŒì—… ì»¨í…ì¸  ì˜ì—­-->
        <div id="popup_contents ">
            <th:block th:replace="popup/detailPopup"></th:block>
        </div>
    </div>
</div>
</body>
<script>

</script>
</html>
