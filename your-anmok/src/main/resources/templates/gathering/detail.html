<!doctype html>
<html lang="ko">
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.0/css/bootstrap.min.css"
          xmlns:sec="http://www.w3.org/1999/xhtml">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<!--    Ìè∞Ìä∏ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/all.min.css"/>
</head>
<body>

<div class="container my-3">
    <div class="back">
        <i class="fas fa-arrow-left fa-2x" onclick="location.href='/gathering/list'"></i>
    </div>
    <div class="d-flex flex-row">
        <section class="content w-75">
            <div class="content_wrap">
                <div class="title d-flex justify-content-between">
                    <h2 th:text="${detailList.getTitle()}"></h2>
                    <div>
                        <a th:href="@{|/gathering/modify/${id}|}" class="btn btn-sm btn-outline-secondary"
                           sec:authorize="isAuthenticated()"
                           th:if="${#authentication.getPrincipal().getId() == detailList.getUserId()}"
                           th:text="ÏàòÏ†ï"></a>
                        <a th:href="@{|/gathering/delete/${id}|}" class="btn btn-sm btn-outline-secondary"
                           sec:authorize="isAuthenticated()"
                           th:if="${#authentication.getPrincipal().getId() == detailList.getUserId()}"
                           onClick="if(!confirm('Ï†ïÎßêÎ°ú ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return false;" th:text="ÏÇ≠Ï†ú"></a>
                    </div>
                </div>

<!--                </div>-->
                <div class="name">
                    <p th:text="${detailList.getNickname()}"></p>
                    <p th:text="${#temporals.format(detailList.getCreatedAt(), 'yyyy.MM.dd HH:mm:ss')}"></p>
                </div>

                <div class="text">
                    <p th:text="${detailList.getText()}"></p>
                </div>

                <div class="comment">
                    <p>üí¨ ÎåìÍ∏Ä</p>
                    <p>&#40; <span th:text="${commentList.size()}"></span> &#41;</p>
                </div>

                <div class="card my-3" th:each="comment, index:${commentList}">
                    <div class="card-body">
                        <a th:id="${comment.commentId}"></a>
                        <div class="d-flex flex-row">
                            <div class="box">
                                <img th:src="${comment.img}" alt="ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ">
                            </div>
                            <div class="m-2 w-100">
                                <div class="d-flex justify-content-between ">
                                    <div th:text="${comment.nickname}"></div>
                                    <div th:text="${comment.createdAt}"></div>
                                </div>
                                <div th:id="|origin-${comment.commentId}|" class="d-block d-flex m-2 justify-content-between ">
                                    <div  th:text="${comment.comment}"></div>
                                    <div>
                                        <div class="btn bg-light text-dark btn-sm text-start rounded-pill" th:id="|${comment.commentId}|" th:field="|comment-btn-${comment.commentId}|"
                                             sec:authorize="isAuthenticated()"
                                             th:reply="|reply-${comment.commentId}|" th:nick="${comment.nickname}" th:userId="${comment.userId}"
                                             onclick="doAction(this.id, this.getAttribute('reply'), this.getAttribute('nick'), this.getAttribute('userId'))">‚§¥Ô∏è ÎãµÏû•</div>

                                        <div class="btn bg-light text-dark btn-sm text-start rounded-pill" th:id="|${comment.commentId}|"
                                             sec:authorize="isAuthenticated()"
                                             th:if="${#authentication.getPrincipal().getId() == comment.userId}"
                                             onclick="doModify(this.id)">ÏàòÏ†ï</div>
                                        <div class="btn bg-light text-dark btn-sm text-start rounded-pill"
                                             sec:authorize="isAuthenticated()"
                                             th:if="${#authentication.getPrincipal().getId() == comment.userId}"
                                             th:onclick="if(confirm('Ï†ïÎßêÎ°ú ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) deleteById([[${id}]],[[${comment.commentId}]])">ÏÇ≠Ï†ú</div>
                                    </div>
                                </div>
                                <div th:id="|modify-${comment.commentId}|" class="d-none m-2 justify-content-between ">
<!--                                    @{/agreements/{id}(id=${agreementsEntity.id})}-->
                                    <form method="post" th:action="@{/comment/modify/{id}/{commentId}(id=${id},commentId=${comment.commentId})}" class="d-flex input-group input-group-type-1">
                                        <input type="text" name="content" th:value="${comment.comment}" class="form-control" aria-describedby="basic-addon3">
                                        <button class="btn btn-outline-danger btn-sm m-0" type="button" th:onclick="cancel([[${comment.commentId}]])">Ï∑®ÏÜå</button>
                                        <input type="submit" class="btn btn-outline-dark btn-sm m-0" value="ÏôÑÎ£å">
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div th:each="reply, index:${comment.replyList}">
                            <div class="ms-5 d-flex flex-row" >
                                <br>
                                <div class="box">
                                    <i class="fa-solid fa-arrow-turn-down-right"></i>
                                    <img th:src="${reply.img}" alt="ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ">
                                </div>
                                <div class="m-2 w-100">
                                    <div class="d-flex justify-content-between ">
                                        <div th:text="${reply.nickname}"></div>
                                        <div th:text="${reply.createdAt}"></div>
                                    </div>
                                    <div th:id="|origin2-${reply.commentId}|" class="d-block d-flex m-2 justify-content-between ">
                                        <div class="d-flex flex-row">
                                            <div class="badge bg-primary rounded-pill align-self-center" name="mentionTo" th:text="|@ ${reply.tagTo}|" ></div>
                                            <div th:text="${reply.comment}"></div>
                                        </div>
                                        <div>
                                            <div th:id="|${comment.commentId}|" th:replys="|reply-${comment.commentId}|" th:nick="${reply.nickname}" th:userId="${comment.userId}"
                                                 th:field="|comment-btn-${reply.commentId}|" class="btn bg-light text-dark btn-sm text-start rounded-pill"
                                                 sec:authorize="isAuthenticated()"
                                                 onclick="doAction(this.id, this.getAttribute('replys'), this.getAttribute('nick'), this.getAttribute('userId'))">‚§¥Ô∏è ÎãµÏû•</div>
                                            <div class="btn bg-light text-dark btn-sm text-start rounded-pill" th:id="|${reply.commentId}|"
                                                 sec:authorize="isAuthenticated()"
                                                 th:if="${#authentication.getPrincipal().getId() == reply.userId}"
                                                 onclick="doModify2(this.id)">ÏàòÏ†ï</div>
                                            <div class="btn bg-light text-dark btn-sm text-start rounded-pill"
                                                 sec:authorize="isAuthenticated()"
                                                 th:if="${#authentication.getPrincipal().getId() == reply.userId}"
                                                 th:onclick="if(confirm('Ï†ïÎßêÎ°ú ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) deleteById([[${id}]],[[${reply.commentId}]])">ÏÇ≠Ï†ú</div>
                                        </div>
                                    </div>
                                    <div th:id="|modify2-${reply.commentId}|" class="d-none m-2 justify-content-between ">
                                        <form method="post" th:action="@{/comment/modify/{id}/{commentId}(id=${id},commentId=${reply.commentId})}" class="d-flex input-group input-group-type-1">
                                            <input type="text" name="content" th:value="${reply.comment}" class="form-control" aria-describedby="basic-addon3">
                                            <button class="btn btn-outline-danger btn-sm m-0" type="button" th:onclick="cancel2([[${reply.commentId}]])">Ï∑®ÏÜå</button>
                                            <input type="submit" class="btn btn-outline-dark btn-sm m-0" value="ÏôÑÎ£å">
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <form th:action="@{|/comment/create/${id}|}" th:object="${commentForm}" method="post">
                            <input type="hidden" th:id="applyTo" name="applyTo" th:value="${comment.commentId}" />
                            <input type="hidden" th:id="|mentionTo${comment.commentId}|" name="mentionTo" value="" />

                            <div style="display:none !important" th:id="|reply-${comment.commentId}|" th:field="|reply-${comment.commentId}|"  class="d-flex input-group input-group-type-1">
                                  <span class="input-group-text" th:if="${comment.commentId != null}">
                                      <span th:id="|reply-nickname-${comment.commentId}|" value="" class="badge bg-primary rounded-pill">@ Îã§Ï†ï</span>
                                  </span>
                                <input type="text"  th:field="*{content}" class="form-control" aria-describedby="basic-addon3">
                                <input type="submit" class="btn btn-outline-dark btn-sm m-0" value="ÏûëÏÑ±">
                            </div>
                        </form>
                    </div>
                </div>
                <h5 class="border-bottom my-3 py-2">üìù ÎåìÍ∏ÄÏûëÏÑ±</h5>
                <form th:action="@{|/comment/create/${id}|}" th:object="${commentForm}" method="post" class="my-3">
                    <!--                    <div th:replace="form_errors :: formErrorsFragment"></div>-->
                    <textarea sec:authorize="isAuthenticated()" name="content" th:field="*{content}" rows="2" class="form-control"></textarea>
                    <textarea sec:authorize="isAnonymous()" class="form-control" type="text" rows="2" placeholder="ÎåìÍ∏ÄÏùÑ Îã¨Î†§Î©¥ Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî." disabled></textarea>
                    <div class="d-flex justify-content-end" sec:authorize="isAuthenticated()">
                        <input type="submit" value="ÎåìÍ∏ÄÎã¨Í∏∞" class="btn btn-outline-dark btn-sm m-2">
                    </div>
                </form>
            </div>
        </section>


        <div class="map w-20">
            <h2>‚ö°Ô∏è Ïû•ÏÜå Ï†ïÎ≥¥</h2>
            <div id="map" style="width:350px; height:200px;"></div>
            <div class="my-3">
                <p th:text="${detailList.getPlaceName()}"></p>
                <p><span th:text="${detailList.getAddress()}"></span></p>

                <hr>
                <div>
                    <p>üìÜ ÎÇ†Ïßú</p>
                    <p th:text="${#temporals.format(detailList.getGatheringDate(), 'yyyy.MM.dd')}"></p>
                </div>

                <div>
                    <p>üë• Ïù∏Ïõê</p>
                    <p> ÌòÑÏû¨ Ïù∏Ïõê : <span th:text="${detailList.getGatherCnt()}"></span>
                        <br>
                        Ï¥ù Ïù∏Ïõê : <span th:text="${detailList.getTotalCnt()}"></span></p>
                </div>

                <div class="d-flex flex-row">
                    <p class="text-nowrap">‚≠êÔ∏è Î≥ÑÏ†ê</p>
                    <div class="star-bar d-flex flex-row align-self-center">
                        <th:block th:each="i : ${detailList.getStar() > 5? #numbers.sequence(1, 5) : #numbers.sequence(1, detailList.getStar())}">
                            <div class="m-1"><img src="/images/star.png" class="star m-0"></div>
                        </th:block>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=0faeb3dc4793a50259747d85fd7d9a89"></script>
<script>
    var lat = [[${detailList.getLat()}]];
    var lon = [[${detailList.getLon()}]];

    console.log(lat);
    console.log(lon);

    var mapContainer = document.getElementById('map'), // ÏßÄÎèÑÎ•º ÌëúÏãúÌï† div
        mapOption = {
            center: new kakao.maps.LatLng(lat, lon), // ÏßÄÎèÑÏùò Ï§ëÏã¨Ï¢åÌëú
            level: 3 // ÏßÄÎèÑÏùò ÌôïÎåÄ Î†àÎ≤®
        };

    // ÏßÄÎèÑÎ•º ÌëúÏãúÌï† divÏôÄ  ÏßÄÎèÑ ÏòµÏÖòÏúºÎ°ú  ÏßÄÎèÑÎ•º ÏÉùÏÑ±Ìï©ÎãàÎã§
    var map = new kakao.maps.Map(mapContainer, mapOption);

    // ÎßàÏª§Í∞Ä ÌëúÏãúÎê† ÏúÑÏπòÏûÖÎãàÎã§
    var markerPosition  = new kakao.maps.LatLng(lat, lon);

    // ÎßàÏª§Î•º ÏÉùÏÑ±Ìï©ÎãàÎã§
    var marker = new kakao.maps.Marker({
        position: markerPosition
    });

    // ÎßàÏª§Í∞Ä ÏßÄÎèÑ ÏúÑÏóê ÌëúÏãúÎêòÎèÑÎ°ù ÏÑ§Ï†ïÌï©ÎãàÎã§
    marker.setMap(map);

    // ÏïÑÎûò ÏΩîÎìúÎäî ÏßÄÎèÑ ÏúÑÏùò ÎßàÏª§Î•º Ï†úÍ±∞ÌïòÎäî ÏΩîÎìúÏûÖÎãàÎã§
    // marker.setMap(null);
    // forms


    function doAction(id, replys, nickname, userId) {
        const btn1 = document.getElementById(id);
        const replyInputForm = document.getElementById(replys);
        const replyNickname = document.getElementById("reply-nickname-"+id);
        const mentionId = document.getElementById("mentionTo"+id);

        if(btn1.style.display != 'none') {
            replyInputForm.style.display = 'block';
            // document.getElementById(replyNickname).innerHTML = nickname + "ÎãòÏóêÍ≤å ÎãµÍ∏Ä ÎÇ®Í∏∞Îäî Ï§ë...";
            mentionId.value = userId;
            replyNickname.innerHTML = "@ "+ nickname;
        } else {
            replyInputForm.style.display = 'block';
        }
    }

    function doModify(id) {
        const originId = "origin-"+id;
        const modifyId = "modify-"+id;

        const originForm = document.getElementById(originId);
        const modifyForm = document.getElementById(modifyId);

        originForm.classList.remove('d-block')
        originForm.classList.add('d-none');

        modifyForm.classList.remove('d-none');
        modifyForm.classList.add('d-block');
    }

    function doModify2(id) {
        const originId = "origin2-"+id;
        const modifyId = "modify2-"+id;

        const originForm = document.getElementById(originId);
        const modifyForm = document.getElementById(modifyId);

        originForm.classList.remove('d-block')
        originForm.classList.add('d-none');

        modifyForm.classList.remove('d-none');
        modifyForm.classList.add('d-block');
    }

    function cancel(id) {
        const originId = "origin-"+id;
        const modifyId = "modify-"+id;

        const originForm = document.getElementById(originId);
        const modifyForm = document.getElementById(modifyId);

        originForm.classList.remove('d-none');
        originForm.classList.add('d-block')

        modifyForm.classList.remove('d-block');
        modifyForm.classList.add('d-none');

    }

    function cancel2(id) {
        const originId = "origin2-"+id;
        const modifyId = "modify2-"+id;

        const originForm = document.getElementById(originId);
        const modifyForm = document.getElementById(modifyId);

        originForm.classList.remove('d-none');
        originForm.classList.add('d-block')

        modifyForm.classList.remove('d-block');
        modifyForm.classList.add('d-none');

    }

    const deleteById  = (id,commentId) => {
        // console.log(commentId);
        const reqUrl = "/comment/delete/"+id+"/"+commentId;
        $.ajax({
            type : 'get',
            url : reqUrl,

            success : function(){
                alert('ÎåìÍ∏ÄÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                location.reload();
            }, error(){
                alert('ajax Ïã§Ìå®')
            }
        })
    }
</script>
</body>
<head>
    <meta charset="utf-8">
    <title>ÏÉÅÏÑ∏Î≥¥Í∏∞</title>
    <link rel="stylesheet" type="text/css" href="/css/gathering/detail.css">
</head>

</html>
